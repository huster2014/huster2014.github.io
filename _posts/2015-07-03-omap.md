---
layout: post
title: ceph osd中omap的实现
---

FileStore作为ObjectStore最重要的实现之一，封装了OSD底层所有I/O操作。FileStore不仅对外提供Object的读写接口，还提供了对Object属性(xattr)和关联kv(omap)的访问接口。xattr和omap都是与某个Object关联key-value对，在实现上xattr利用文件的xattr属性进行存取，而omap则利用DBObjectMap实现存取。由于文件系统在文件xattr长度上的限制，xattr溢出的部分就会被存放在DBObjectMap中，因而xattr和omap操作是互通，只不过前者的长度受限，而后者没有限制罢了。<br>

### DBObjectMap的0-copy clone 技术
DBObjectMap对外提供omap和xattr的操作接口，如set_，get_，rm_以及clone和sync接口。<br>

``` c++
int set_keys(const ghobject_t &oid, const map<string, bufferlist> &set, const SequencerPosition *spos=0);
int set_xattrs(const ghobject_t &oid,  const map<string, bufferlist> &to_set,  const SequencerPosition *spos=0);
int clone(const ghobject_t &oid, const ghobject_t &target, const SequencerPosition *spos); <br>
...
```

从接口来看，Object的xattr(*_xattrs系列)和omap(*_keys系列)只不过是与该Object关联的多个kv对构成的map。由于xattr适合于长度较短的kv对，而omap适用于较长的kv对，在实现clone操作时分别采用不同的方式，对xattr，DBObjectMap采用拷贝的方式，对omap，DBObjectMap采用0-copy的技术。
